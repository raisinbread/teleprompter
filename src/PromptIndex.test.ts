import { describe, expect, it } from 'vitest';
import { Prompts } from './PromptIndex';

export const testVectors = [
  0.023924638, 0.030796655, -0.15431309, -0.04511755, 0.065575406,
  -0.0017170524, 0.065047495, -0.014220442, 0.009008882, -0.049791697,
  0.01900782, 0.05564744, 0.007056586, 0.0041365456, -0.02558646, -0.025889365,
  0.07255674, -0.10917406, -0.010928373, -0.0057433187, 0.02217279,
  -0.019202115, -0.05678229, 0.004038293, 0.08325442, 0.03133203, -0.03758877,
  0.013688566, -0.05602762, -0.012686542, 0.038874548, -0.005973994,
  0.016239189, -0.025469573, -0.07243635, -0.06798274, 0.02668123, 0.058060218,
  -0.057817273, 0.01785081, 0.038415402, 0.007152807, 0.01301365, -0.016560454,
  0.05343227, 0.00090833154, 0.017040785, 0.038515326, 0.012882528,
  -0.007916717, -0.02030557, -0.027416743, 0.009724399, -0.027298182,
  0.05493188, 0.013401398, 0.05066678, -0.016889963, 0.024401123, -0.03986083,
  0.03550857, 0.036134966, -0.07459293, 0.034977112, 0.012387699, -0.054457508,
  -0.028611114, 0.034981776, -0.0012360868, 0.041605163, 0.048905652,
  0.010991559, 0.030176507, -0.02927741, -0.022583837, -0.04871478,
  -0.032962877, -0.005431023, -0.043180004, 0.009979852, 0.051086128,
  -0.009146842, 0.033454705, 0.067051046, 0.062480807, -0.04544658,
  -0.030958463, -0.039947845, -0.03746402, 0.03875901, 0.047760647, 0.0505617,
  0.040899113, 0.00067538896, -0.024704756, 0.021235812, -0.016823579,
  0.049894735, 0.021965269, 0.007213518, -0.011280813, -0.009061132,
  -0.026237221, -0.042025607, 0.011373468, 0.04457868, -0.01885314, 0.031007927,
  -0.03656057, -0.057133656, -0.023507332, 0.04865698, -0.043872457,
  -0.027054137, -0.018535672, -0.027751941, 0.039749797, -0.011477424,
  0.0046329917, 0.028182989, 0.0020540047, 0.025616823, -0.025413318,
  0.024158183, -0.007842928, 0.04629894, -0.05727397, 0.06174787, 0.009259166,
  -0.007415095, 0.006451857, -0.006262966, -0.024832249, -0.041948915,
  0.014146599, 0.044806417, 0.017563334, -0.021466926, 0.015755368, 0.011030001,
  -0.013805504, 0.027383074, -0.011443108, 0.011901781, 0.020125253,
  -0.035386596, 0.054425355, -0.0025794778, 0.00032018987, -0.004240358,
  0.018496182, -0.01935843, 0.034409378, 0.012395357, 0.020051489, -0.028085152,
  0.032247674, -0.020705996, 0.034397796, 0.058112845, 0.035818204,
  -0.027699381, -0.045535363, 0.030110115, -0.027646191, -0.059996113,
  -0.009484831, 0.10809814, 0.04389574, -0.004709438, -0.055207387, -0.0571043,
  0.0045453175, 0.0015277859, -0.036760222, 0.00836819, 0.023042306,
  -0.03305277, 0.041174106, -0.018090082, 0.0627114, -0.04316392, 0.021380741,
  0.009948847, -0.000006250926, -0.05293106, 0.011498807, 0.012323313,
  -0.033862982, -0.024931299, -0.026457129, -0.04003956, -0.08744202,
  -0.059027757, -0.008995235, -0.04007786, 0.049910244, -0.03473085, 0.04946673,
  -0.0040683514, -0.016178256, -0.020273626, -0.029996447, 0.03302698,
  -0.051025074, -0.01476612, -0.035187744, 0.0018256428, -0.010404637,
  0.0210293, 0.08013117, 0.013960015, 0.0007529176, 0.02448018, -0.0040494925,
  -0.040908657, -0.0010099635, -0.010700755, -0.018561324, 0.009460943,
  0.014289966, -0.028963413, -0.0039860005, -0.060089536, -0.0079539465,
  -0.0091808345, -0.03836916, -0.044840973, -0.03720474, 0.012568415,
  0.007089616, -0.046531916, 0.068612486, -0.009200567, 0.039099775,
  0.007877637, -0.03468018, 0.030097382, -0.01530682, 0.01988572, -0.023009872,
  0.05321768, -0.0009272522, 0.011070376, -0.03015044, -0.007271052,
  0.002946731, -0.051072422, 0.04349478, 0.06304931, -0.021805108, 0.029269386,
  0.018293947, 0.043965332, 0.008141144, -0.06502378, -0.033704784, 0.010671466,
  -0.015730288, -0.05419382, 0.007909978, -0.041590836, 0.009753547,
  -0.0014870889, -0.033808015, -0.042936716, -0.03251433, 0.012114405,
  0.004249239, -0.010215071, 0.008089299, 0.024369624, 0.03575152, 0.016575685,
  0.020643368, -0.04007556, 0.017924793, -0.021014825, 0.017025255, 0.042732082,
  -0.010800713, -0.0154937785, -0.032682598, 0.03151097, 0.027474444,
  0.024746578, 0.026232917, 0.0040452583, -0.013448211, 0.012287358,
  -0.036797147, 0.018951071, -0.02189281, 0.041405067, -0.015143604,
  0.015305781, 0.07341541, -0.027608357, 0.004047768, 0.0028799376, -0.00669134,
  0.016730564, 0.03797712, 0.0330798, 0.017610801, -0.019249931, 0.05860177,
  -0.031623095, 0.04537518, 0.0022101856, -0.049141455, -0.015826201,
  -0.020197617, 0.022243258, -0.047944315, 0.04820954, 0.024603924, 0.035999645,
  0.045577995, -0.048299152, 0.031564903, -0.07935178, 0.01697857, 0.040382084,
  -0.016183654, 0.030214414, 0.02378088, 0.037049703, -0.04915663, -0.027579805,
  0.058756493, 0.077599, -0.035883628, -0.017585576, -0.0131095415, 0.015887355,
  0.026042232, 0.023066236, -0.02367246, 0.015567639, 0.06814031, -0.03406727,
  0.034871332, 0.007621473, 0.044120066, -0.038032398, 0.009557192,
  -0.0037716236, 0.039745204, 0.038694113, -0.04528478, 0.024945749,
  0.004815396, -0.018063875, 0.047730807, 0.0068018967, 0.051346205,
  0.012467016, 0.02648593, -0.008319154, 0.032459594, -0.022101339, 0.013408219,
  -0.0031887293, 0.022779953, -0.01185304, -0.00006802648, 0.022601655,
  0.037887443, 0.041513346, -0.0016857891, -0.0057889996, 0.011882802,
  0.08229197, 0.072114535, 0.025627222, -0.078908354, -0.047056634,
  -0.016903503, 0.021889787, 0.023173606, -0.0071962643, -0.0151423365,
  -0.013696939, 0.055024736, -0.01722677, 0.007648617, -0.010378525,
  0.032945257, -0.0064853677, -0.0017680672, 0.007803168, -0.07365834,
  0.061012078, -0.0153056085, -0.008272321, 0.04093124, 0.006152677,
  -0.055645116, 0.0068394626, -0.032583695, -0.059544273, -0.016046772,
  0.029034602, -0.014630485, 0.025965543, -0.029898189, -0.014318945,
  0.02930379, -0.020909082, 0.046954215, 0.0036589499, -0.03840534,
  -0.026628288, -0.00710151, 0.014865416, 0.047431905, 0.03957822, 0.0033875324,
  0.030407507, -0.035303004, 0.06928028, -0.008749404, 0.006485537,
  -0.016889764, -0.03388243, 0.00844587, 0.09041061, 0.01934021, -0.0989722,
  -0.022799948, 0.0047833635, -0.011374565, 0.018346505, -0.0004129649,
  0.04450124, -0.025484024, -0.007613052, 0.015809482, 0.032302666,
  -0.000018605673, -0.035337437, -0.02544235, -0.037244648, 0.0069378293,
  0.10462877, 0.058155596, -0.04137211, -0.03965057, -0.034013454, -0.03379547,
  0.028484186, 0.0027013118, 0.053451907, 0.050190378, -0.06533203, 0.061316304,
  0.008381336, -0.014614936, 0.055142805, 0.00075095904, -0.0053205094,
  0.019655332, 0.029445564, 0.034025807, -0.025386553, 0.029579777,
  -0.007069863, 0.03375413, 0.046444945, -0.025411844, -0.040350784,
  0.063154474, -0.009210967, 0.007137818, -0.0026801955, -0.042188488,
  0.014979553, -0.01500989, 0.068110116, 0.0077756653, 0.012193766,
  -0.0051406706, -0.05794205, 0.03470538, -0.005779994, 0.023970319,
  0.018701985, 0.036819734, -0.02143328, 0.049053457, 0.0014252906, 0.005402904,
  -0.0019960352, -0.03032818, -0.022071678, -0.054736424, -0.01623822,
  0.017072584, -0.0038647314, 0.006885493, 0.011445276, 0.006610681,
  -0.015102344, -0.047724247, -0.042921178, -0.05042596, -0.075871386,
  -0.065060735, 0.01659169, -0.028613701, 0.0011648989, 0.054754417,
  0.027889565, 0.016984392, 0.000025398525, 0.008388676, -0.0017947226,
  -0.022881975, 0.031264327, 0.042607885, -0.006067766, -0.013776164,
  -0.0494891, -0.05835278, 0.02309474, 0.010107796, -0.020318653, 0.07082893,
  0.07030814, 0.008008964, 0.03447919, -0.030348768, -0.036272407, -0.01847085,
  -0.024668066, -0.0489143, 0.023143582, 0.003151395, 0.0110242115,
  -0.063398786, -0.0060337805, 0.007827975, -0.042797297, 0.034424007,
  0.020898705, -0.09133982, -0.0067210686, -0.0201396, -0.050740253,
  0.0041614305, -0.036755223, -0.053571545, -0.0028696232, 0.03143962,
  -0.0551806, 0.003772153, -0.052531544, -0.008500076, -0.059480797,
  0.038155712, 0.007081636, 0.0047860336, 0.014343551, 0.0051782713,
  -0.052214354, -0.038509615, 0.026800033, 0.01925813, -0.008992669,
  0.042098552, -0.0374378, 0.0073464876, -0.02251591, -0.066343516,
  0.0026374282, 0.03293636, 0.07938972, -0.01788387, -0.026447594, 0.054854598,
  -0.014143035, 0.036048613, 0.046908993, -0.0029456485, -0.0049724276,
  -0.023837168, -0.012075042, -0.0013636912, -0.00053317274, -0.033763383,
  -0.051279433, -0.00033071663, -0.035890356, 0.022038491, 0.024434417,
  -0.010012864, -0.058257155, -0.02506331, -0.015640844, -0.00958715,
  0.018549923, 0.023344094, -0.033692673, 0.019932644, 0.022065775, 0.06402028,
  -0.0031441338, 0.012857933, -0.03312516, 0.037563026, 0.031099252,
  -0.056567203, 0.04411553, 0.042714383, -0.038201515, 0.09698414, -0.029347738,
  -0.0064378055, -0.049457714, 0.026436301, -0.064975545, 0.05697539,
  -0.050554663, -0.0070815873, -0.024957357, -0.051303808, 0.023332836,
  0.008643348, 0.058558118, -0.06881099, -0.000047868005, -0.07471434,
  -0.053049315, -0.068266764, 0.015119909, -0.020326572, -0.017691292,
  0.05292921, 0.058035303, 0.047569707, -0.021380318, -0.03641311, -0.013070269,
  0.017681863, 0.047153197, 0.059044845, 0.01625133, 0.055196956, -0.043861713,
  0.08689319, 0.07086266, -0.023096196, -0.048510227, 0.034113485, 0.023349961,
  0.026939465, -0.004191058, -0.0038353817, -0.031295612, -0.027812745,
  -0.00019067443, -0.06272088, 0.012542967, 0.02970207, 0.028542323,
  -0.013684564, -0.04817258, -0.031204695, -0.044721212, 0.03169137,
  -0.012448136, 0.043195326, 0.030090667, 0.008355421, 0.00974737, 0.020719755,
  0.057767697, -0.007818618, -0.034980692, -0.02395438, -0.04921892,
  0.026826939, 0.0070022466, 0.0493146, -0.08670855, 0.03434356, -0.050910592,
  -0.006583192, 0.015663844, 0.006083502, 0.012771407, -0.008179243,
  -0.05513765, 0.02832075, -0.03922327, 0.03251918, 0.0058296374, 0.013223257,
  0.059382763, -0.039759554, 0.05482856, 0.0003528285, 0.045844335, -0.07321281,
  -0.0119358115, 0.011385392, -0.0001610555, -0.036336362, -0.06909834,
  0.041514706, 0.02142501, -0.01559846, 0.046119794, 0.018320043, 0.04886878,
  -0.035355132, -0.014642309, 0.022242686, 0.0030183382, 0.045213927,
  0.0073254965, -0.042124152, -0.019039815, -0.01649853, -0.043945484,
  0.032164916, -0.03587517, 0.0432327, -0.050281115, -0.028825108, -0.024318028,
  -0.02047044, 0.02588248, -0.013050378, -0.017817391, -0.039692, -0.006993183,
  -0.021472486, 0.017625446, -0.007087528, 0.009962443, -0.032198817,
  0.0021760052, 0.013694452, -0.020522522, -0.048495527, 0.03550358,
  0.024187997, -0.03837473, 0.025265275, -0.07692381, -0.030739725, 0.02633461,
  -0.0034359826, -0.024681903, -0.033888232, 0.054548033, 0.10554788,
  -0.0067342822, -0.0070887078, 0.0073656035, 0.040398356, 0.0068780137,
  -0.00783533, -0.047639508, -0.024910199, -0.014968876,
];

describe('PromptIndex', () => {
  it.skipIf(process.env.SKIP_INTEGRATION_TESTS)(
    'can generate vectors (ollama)',
    async () => {
      const index = new Prompts('ollama');
      const vectors = await index.generateVectors('This is a test prompt');
      expect(Array.isArray(vectors)).toBe(true);
      expect(vectors.length).toBe(768);
    },
    10_000,
  );

  it.skipIf(process.env.SKIP_INTEGRATION_TESTS)(
    'can generate vectors (openai)',
    async () => {
      const index = new Prompts('openai');
      const vectors = await index.generateVectors('This is a test prompt');
      expect(Array.isArray(vectors)).toBe(true);
      expect(vectors.length).toBe(768);
    },
    10_000,
  );

  it('successfully saves and queries prompts', async () => {
    const index = new Prompts(undefined, '/tmp/prompts');
    await index.reset();

    await index.create('This is a test prompt', {
      name: 'Test Prompt',
      description: 'This is a test prompt',
    });
    const result = await index.query('This is a test prompt');

    expect(result.length).toBe(1);
    expect(result[0].item.metadata.name).toBe('Test Prompt');
    expect(result[0].item.metadata.description).toBe('This is a test prompt');
    expect(result[0].item.vector).toEqual(testVectors);
  });
});
